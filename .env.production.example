# =============================================================================
# TRACK RECORD ENCLAVE - PRODUCTION ENVIRONMENT
# =============================================================================
# ⚠️  CRITICAL: This file contains production configuration structure
# ⚠️  NEVER commit the actual .env.production with real secrets to Git
# ⚠️  Use a secret manager (AWS Secrets Manager, Azure Key Vault, HashiCorp Vault)
# =============================================================================

# -----------------------------------------------------------------------------
# ENCLAVE CONFIGURATION
# -----------------------------------------------------------------------------
ENCLAVE_MODE=true
AMD_SEV_SNP=true  # Set to true ONLY on AMD SEV-SNP hardware
ENCLAVE_PORT=50051

# -----------------------------------------------------------------------------
# DATABASE (Enclave User - Full Access)
# -----------------------------------------------------------------------------
# Production: Use managed PostgreSQL (Azure Database, AWS RDS, GCP Cloud SQL)
# Format: postgresql://USER:PASSWORD@HOST:PORT/DATABASE?sslmode=require
DATABASE_URL="postgresql://enclave_user:CHANGE_THIS_PASSWORD@your-postgres-server.postgres.database.azure.com:5432/aggregator_db?sslmode=require"

# For Azure Database for PostgreSQL Flexible Server:
# DATABASE_URL="postgresql://enclave_user@your-server:CHANGE_THIS_PASSWORD@your-server.postgres.database.azure.com:5432/aggregator_db?sslmode=require"

# For AWS RDS PostgreSQL:
# DATABASE_URL="postgresql://enclave_user:CHANGE_THIS_PASSWORD@your-rds-instance.us-east-1.rds.amazonaws.com:5432/aggregator_db?sslmode=require"

# -----------------------------------------------------------------------------
# SECURITY (CRITICAL - INJECT VIA SECRET MANAGER)
# -----------------------------------------------------------------------------
# ⚠️  DO NOT hardcode these values in production
# ⚠️  Inject via:
#     - Azure Key Vault
#     - AWS Secrets Manager
#     - HashiCorp Vault
#     - Kubernetes Secrets

# 256-bit encryption key (64 hex chars)
# Generate: openssl rand -hex 32
ENCRYPTION_KEY="${AZURE_KEYVAULT_ENCRYPTION_KEY}"  # Injected from vault

# JWT Secret (not used in enclave but may be needed)
JWT_SECRET="${AZURE_KEYVAULT_JWT_SECRET}"  # Injected from vault

# -----------------------------------------------------------------------------
# TLS CERTIFICATES (Mutual TLS for gRPC)
# -----------------------------------------------------------------------------
# Production: Use CA-signed certificates from Let's Encrypt or corporate CA
TLS_CA_CERT="/etc/enclave/certs/ca.crt"
TLS_SERVER_CERT="/etc/enclave/certs/server.crt"
TLS_SERVER_KEY="/etc/enclave/certs/server.key"
TLS_CLIENT_CERT="/etc/enclave/certs/client.crt"  # For mTLS with Gateway

# Enable mutual TLS (client certificate verification)
GRPC_MTLS_ENABLED=true

# -----------------------------------------------------------------------------
# LOGGING
# -----------------------------------------------------------------------------
# Production log level (error, warn, info - NEVER debug in production)
LOG_LEVEL="info"

# Disable query logging in production (performance + security)
QUERY_LOGGING="false"

# Log format (json for centralized logging, text for humans)
LOG_FORMAT="json"

# Optional: External log shipping
# LOKI_ENDPOINT="https://your-loki-instance.com/loki/api/v1/push"
# LOKI_AUTH_TOKEN="${LOKI_TOKEN}"

# -----------------------------------------------------------------------------
# MONITORING & HEALTH CHECKS
# -----------------------------------------------------------------------------
# Prometheus metrics endpoint (internal network only)
METRICS_ENABLED=true
METRICS_PORT=9090
METRICS_PATH="/metrics"

# Health check settings
HEALTH_CHECK_TIMEOUT_MS=5000
HEALTH_CHECK_DATABASE=true
HEALTH_CHECK_ATTESTATION=true

# -----------------------------------------------------------------------------
# ATTESTATION (AMD SEV-SNP Production)
# -----------------------------------------------------------------------------
# Azure Confidential VM IMDS endpoint
ATTESTATION_ENDPOINT="http://169.254.169.254/metadata/attested/document"

# GCP Confidential VM endpoint (if using GCP instead)
# ATTESTATION_ENDPOINT="http://metadata.google.internal/computeMetadata/v1/instance/confidential-computing/attestation-report"

# Cached VCEK certificate path (AMD SEV-SNP)
AMD_VCEK_CACHE_PATH="/etc/enclave/vcek.pem"

# Require valid attestation before accepting gRPC connections
ATTESTATION_REQUIRED=true

# -----------------------------------------------------------------------------
# RATE LIMITING & PROTECTION
# -----------------------------------------------------------------------------
# gRPC request rate limit (requests per minute per client)
GRPC_RATE_LIMIT=60

# Maximum concurrent gRPC connections
GRPC_MAX_CONNECTIONS=100

# Request timeout (milliseconds)
GRPC_REQUEST_TIMEOUT_MS=30000

# -----------------------------------------------------------------------------
# SCHEDULER CONFIGURATION
# -----------------------------------------------------------------------------
# Daily sync cron schedule (00:00 UTC)
DAILY_SYNC_CRON="0 0 * * *"

# Sync rate limit (hours between syncs)
SYNC_RATE_LIMIT_HOURS=23

# -----------------------------------------------------------------------------
# PERFORMANCE
# -----------------------------------------------------------------------------
# Node.js memory limit (MB)
NODE_OPTIONS="--max-old-space-size=2048"

# Enable V8 memory protections
NODE_OPTIONS="--max-old-space-size=2048 --no-expose-wasm --no-experimental-wasm-modules"

# -----------------------------------------------------------------------------
# NETWORK SECURITY
# -----------------------------------------------------------------------------
# Allowed Gateway IPs (comma-separated, for firewall rules)
ALLOWED_GATEWAY_IPS="10.0.1.5,10.0.1.6"

# Bind to internal network interface only
GRPC_BIND_ADDRESS="0.0.0.0"  # Change to specific IP if needed

# -----------------------------------------------------------------------------
# NODE ENVIRONMENT
# -----------------------------------------------------------------------------
NODE_ENV="production"

# Disable source maps in production
GENERATE_SOURCEMAP=false

# -----------------------------------------------------------------------------
# BACKUP & DISASTER RECOVERY
# -----------------------------------------------------------------------------
# Database backup schedule (handled by managed PostgreSQL)
# BACKUP_ENABLED=true
# BACKUP_RETENTION_DAYS=30

# -----------------------------------------------------------------------------
# FEATURE FLAGS
# -----------------------------------------------------------------------------
# Enable enclave log streaming to HTTP endpoint
ENABLE_ENCLAVE_LOG_STREAMING=false

# Enable debug endpoints (MUST be false in production)
ENABLE_DEBUG_ENDPOINTS=false

# =============================================================================
# DEPLOYMENT CHECKLIST
# =============================================================================
# Before deploying to production, verify:
#
# ✅ ENCRYPTION_KEY injected from Azure Key Vault / AWS Secrets Manager
# ✅ DATABASE_URL points to managed PostgreSQL with SSL
# ✅ TLS certificates signed by trusted CA (not self-signed)
# ✅ AMD_SEV_SNP=true on AMD SEV-SNP hardware
# ✅ LOG_LEVEL=info or warn (NEVER debug)
# ✅ QUERY_LOGGING=false
# ✅ ATTESTATION_REQUIRED=true
# ✅ GRPC_MTLS_ENABLED=true
# ✅ ENABLE_DEBUG_ENDPOINTS=false
# ✅ Firewall rules restrict port 50051 to internal network
# ✅ Health checks configured in orchestrator (Kubernetes/Docker Swarm)
# ✅ Prometheus metrics scraped
# ✅ Alerts configured (PagerDuty, Opsgenie, etc.)
#
# =============================================================================
