version: '3.8'

# =============================================================================
# Track Record Enclave - Production Docker Compose
# =============================================================================
# This is a REFERENCE configuration for production deployment
#
# ⚠️  IMPORTANT: For production, use Kubernetes/Docker Swarm instead
# ⚠️  This file is for testing production-like setup in staging
#
# Features:
# - Enclave container with security hardening
# - Prometheus metrics collection
# - Health checks
# - No PostgreSQL (use managed database in production)
# - TLS/mTLS for gRPC
# - Resource limits
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Enclave Service (AMD SEV-SNP)
  # ---------------------------------------------------------------------------
  enclave:
    build:
      context: .
      dockerfile: Dockerfile.reproducible
    container_name: track-record-enclave-prod

    # Security: Run with minimal privileges
    user: "1000:1000"
    read_only: true  # Filesystem read-only

    # Security: Drop all capabilities except necessary ones
    cap_drop:
      - ALL
    cap_add:
      - IPC_LOCK  # For memory locking

    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined  # Required for AMD SEV-SNP

    # AMD SEV-SNP device access (required for attestation)
    devices:
      - /dev/sev-guest:/dev/sev-guest

    # Environment variables (DO NOT hardcode secrets here!)
    env_file:
      - .env.production  # Load from secret file (injected by orchestrator)

    environment:
      - NODE_ENV=production
      - ENCLAVE_MODE=true
      - AMD_SEV_SNP=true

    # Ports (INTERNAL network only - DO NOT expose to internet)
    ports:
      - "127.0.0.1:50051:50051"  # gRPC (bind to localhost only)
      - "127.0.0.1:9090:9090"    # Prometheus metrics (localhost only)

    # Volume mounts
    volumes:
      # TLS certificates (read-only)
      - /etc/enclave/certs:/etc/enclave/certs:ro

      # Logs (writable)
      - enclave_logs:/var/log/enclave:rw

      # Temp directory (writable, in-memory)
      - /tmp

    # Temporary filesystem mounts (in-memory, no disk writes)
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=100m

    # Resource limits (prevent resource exhaustion)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G

    # Health check (robust - checks gRPC, database, attestation)
    healthcheck:
      test: ["CMD", "node", "-e", "require('./dist/health-check.js')"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3

    # Restart policy
    restart: unless-stopped

    # Network
    networks:
      - enclave_internal

    # Logging (JSON format for log aggregation)
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service,environment"

    # Labels (for monitoring and orchestration)
    labels:
      - "com.track-record.service=enclave"
      - "com.track-record.environment=production"
      - "com.track-record.version=1.0.0"

  # ---------------------------------------------------------------------------
  # Prometheus (Metrics Collection)
  # ---------------------------------------------------------------------------
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: track-record-prometheus

    user: "65534:65534"  # nobody user
    read_only: true

    # Configuration
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus

    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'

    ports:
      - "127.0.0.1:9091:9090"  # Prometheus UI (localhost only)

    networks:
      - enclave_internal

    restart: unless-stopped

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # ---------------------------------------------------------------------------
  # Grafana (Optional - Metrics Visualization)
  # ---------------------------------------------------------------------------
  # Uncomment if you want a dashboard (remove for minimal production)
  # grafana:
  #   image: grafana/grafana:10.2.2
  #   container_name: track-record-grafana
  #
  #   user: "472:472"
  #
  #   volumes:
  #     - grafana_data:/var/lib/grafana
  #     - ./monitoring/grafana-dashboards:/etc/grafana/provisioning/dashboards:ro
  #     - ./monitoring/grafana-datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
  #
  #   environment:
  #     - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
  #     - GF_USERS_ALLOW_SIGN_UP=false
  #     - GF_SERVER_ROOT_URL=http://localhost:3000
  #
  #   ports:
  #     - "127.0.0.1:3000:3000"
  #
  #   networks:
  #     - enclave_internal
  #
  #   restart: unless-stopped

# =============================================================================
# Networks
# =============================================================================
networks:
  enclave_internal:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
    # Enable encryption (if using Docker Swarm with overlay network)
    # driver_opts:
    #   encrypted: "true"

# =============================================================================
# Volumes
# =============================================================================
volumes:
  enclave_logs:
    driver: local

  prometheus_data:
    driver: local

  # grafana_data:
  #   driver: local

# =============================================================================
# PRODUCTION DEPLOYMENT NOTES
# =============================================================================
#
# 1. Deployment Options:
#    - For MVP / Single VM: Docker Compose + systemd (RECOMMENDED - simple)
#    - For HA (2-3 instances): Docker Swarm
#    - For Enterprise: Kubernetes (only if you have DevOps team)
#    See deployment/DEPLOYMENT_COMPARISON.md for detailed comparison
#
# 2. Secrets Management:
#    - Use Docker Secrets (Swarm) or Kubernetes Secrets
#    - Inject ENCRYPTION_KEY from Azure Key Vault / AWS Secrets Manager
#    - Never hardcode secrets in .env.production
#
# 3. Database:
#    - Use managed PostgreSQL (Azure Database, AWS RDS, GCP Cloud SQL)
#    - Configure in DATABASE_URL with SSL (sslmode=require)
#    - Set up automated backups (30-day retention)
#
# 4. TLS Certificates:
#    - Use CA-signed certificates (Let's Encrypt, corporate CA)
#    - Mount from /etc/enclave/certs (managed by cert-manager in K8s)
#    - Rotate certificates every 90 days
#
# 5. Monitoring:
#    - Prometheus scrapes metrics from :9090/metrics
#    - Set up alerts for:
#      * High CPU/memory usage
#      * Failed attestation
#      * Database connection errors
#      * gRPC error rate > 1%
#
# 6. Networking:
#    - Port 50051 (gRPC) MUST be internal network only
#    - Use firewall rules to restrict access to Gateway IPs only
#    - Enable mTLS for gRPC (GRPC_MTLS_ENABLED=true)
#
# 7. AMD SEV-SNP:
#    - Deploy on Azure DCasv5/ECasv5 or GCP C2D instances
#    - Verify /dev/sev-guest device is available
#    - Run attestation check before accepting connections
#
# 8. Resource Limits:
#    - Enclave: 2 CPU cores, 2GB RAM
#    - Prometheus: 0.5 CPU cores, 512MB RAM
#    - Adjust based on load testing
#
# 9. Backup & Disaster Recovery:
#    - Database backups: Daily (managed by cloud provider)
#    - ENCRYPTION_KEY: Backup in secure vault (if lost, data is unrecoverable)
#    - Configuration: Infrastructure as Code (Terraform)
#
# 10. Logging:
#     - Logs written to /var/log/enclave (JSON format)
#     - Ship to centralized logging (optional):
#       * Loki (open-source)
#       * Azure Monitor
#       * AWS CloudWatch
#     - Retention: 7 days local, 30 days centralized
#
# =============================================================================
